{% extends 'ECBApp/base.html' %}
{% load static %}
{% load custom_filters %}

{% block breadcrumb %}
    {% for crumb in breadcrumb %}
        <a href="{{ crumb.url }}" class="breadcrumb-item">{{ crumb.name }}</a>
        {% if not forloop.last %} / {% endif %}
    {% endfor %}
{% endblock %}

{% block header_title %}
    View Bill
{% endblock %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Bill</title>
    <link rel="stylesheet" href="{% static 'css/charts.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/view_bill.css' %}?v=1.0">
</head>
<body>
   
    <div class="container">
        <div class="stat-boxes">
            <div class="stat-box">
                <i class="fas fa-coins"></i>
                <h3>Pending Payments</h3>
                <p>₱{{ total_due|floatformat:2 }}</p>
            </div>
            <div class="stat-box">
                <i class="fas fa-check-circle"></i>
                <h3>Total Paid</h3>
                <p>₱{{ total_paid|floatformat:2 }}</p>
            </div>
            <div class="stat-box">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Overdue Bills</h3>
                <p>{{ overdue_bills }}</p>
            </div>
        </div>

        <div class="main-content">
            <div class="table-chart-container">
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Bill ID</th>
                                <th>Bill Date</th>
                                <th>Total Amount</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bill in page_obj.object_list %}
                            <tr class="{% if bill.status == 'Overdue' %}overdue{% endif %}">
                                <td>{{ bill.billID }}</td>
                                <td>{{ bill.billDate }}</td>
                                <td>₱{{ bill.totalAmount }}</td>
                                <td>{{ bill.status }}</td>
                                <td>
                                    {% if bill.status == 'Pending' %}
                                    <a href="{% url 'initiate_payment' bill.billID %}" class="btn">Pay Now</a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5">No bills available.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="chart-container">
                    <canvas id="paymentAnalysisChart"></canvas>
                </div>
            </div>
        
            <div class="pagination">
                <div class="pagination-links">
                    {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}" class="breadcrumb-item">[ Current ]</a>
                    {% endif %}
                    <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="breadcrumb-item">[ Previous ]</a>
                    {% endif %}
                </div>
            </div>
        </div>
        
    </div>

    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const paymentAnalysis = JSON.parse('{{ payment_analysis|escapejs }}');
        
        // Detect current theme
        const currentTheme = document.body.getAttribute('data-theme');
    
        // Set chart background and text colors based on the current theme
        const chartBackgroundColor = currentTheme === 'dark' ? '#444' : '#fff';
        const chartTextColor = currentTheme === 'dark' ? '#fff' : '#000';
        const chartTooltipBackgroundColor = currentTheme === 'dark' ? '#555' : '#fff';
        const chartTooltipTextColor = currentTheme === 'dark' ? '#fff' : '#000';
    
        const ctx2 = document.getElementById('paymentAnalysisChart').getContext('2d');
        
        const paymentAnalysisChart = new Chart(ctx2, {
            type: 'pie',
            data: {
                labels: ['Payments Done', 'Payments Pending'], 
                datasets: [{
                    data: [paymentAnalysis.done, paymentAnalysis.pending],
                    backgroundColor: ['#6574ff', '#f3590b'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 14,
                                weight: '600',
                                color: chartTextColor, // Set text color based on theme
                            },
                            padding: 20,
                        },
                    },
                    tooltip: {
                        backgroundColor: chartTooltipBackgroundColor, // Set tooltip background color
                        titleColor: chartTextColor, // Set tooltip title color
                        bodyColor: chartTooltipTextColor, // Set tooltip body color
                        callbacks: {
                            label: function(tooltipItem) {
                                let label = tooltipItem.label;
                                let value = tooltipItem.raw;
                                return `${label}: ₱${value.toLocaleString()}`;
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        backgroundColor: chartTooltipBackgroundColor, // Tooltip background
                        titleColor: chartTextColor, // Tooltip title color
                        bodyColor: chartTooltipTextColor, // Tooltip body color
                    }
                }
            }
        });
    </script>
    
   
</body>
</html>
{% endblock %}
