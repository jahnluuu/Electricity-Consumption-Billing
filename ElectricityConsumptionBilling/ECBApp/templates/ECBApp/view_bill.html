{% extends 'ECBApp/base.html' %}
{% load static %}
{% load custom_filters %}

{% block breadcrumb %}
    {% for crumb in breadcrumb %}
        <a href="{{ crumb.url }}">{{ crumb.name }}</a>
        {% if not forloop.last %} / {% endif %}
    {% endfor %}
{% endblock %}

{% block header_title %}
    View Bill
{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Bill</title>
    <link rel="stylesheet" href="{% static 'css/charts.css' %}">
    <link rel="stylesheet" href="{% static 'css/view_bill.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
   
    <div class="container">
        <div class="dashboard-overview">
            <!-- Statistic Boxes -->
            <div class="stat-boxes">
                <div class="stat-box">
                    <i class="fas fa-coins"></i>
                    <h3>Pending Payments</h3>
                    <p>₱{{ total_due|floatformat:2 }}</p>
                </div>
                <div class="stat-box">
                    <i class="fas fa-check-circle"></i>
                    <h3>Total Paid</h3>
                    <p>₱{{ total_paid }}</p>
                </div>
                <div class="stat-box">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Overdue Bills</h3>
                    <p>{{ overdue_bills }}</p>
                </div>
            </div>
        </div>

        <!-- Table and Chart Container -->
        <div class="table-chart-container">
            <!-- Table -->
            <table>
                <thead>
                    <tr>
                        <th>Bill Date</th>
                        <th>Total Amount</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bill in bills %}
                    <tr class="{% if bill.status == 'Overdue' %}overdue{% endif %}">
                        <td>{{ bill.billDate }}</td>
                        <td>₱{{ bill.totalAmount }}</td>
                        <td>{{ bill.status }}</td>
                        <td>
                            {% if bill.status == 'Pending' %}
                            <a href="{% url 'initiate_payment' bill.billID %}" class="btn">Pay Now</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4">No bills available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Payment Analysis Chart -->
            <div class="chart-container">
                <canvas id="paymentAnalysisChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const paymentAnalysis = JSON.parse('{{ payment_analysis|escapejs }}');
        
        // Detect current theme
        const currentTheme = document.body.getAttribute('data-theme');
    
        // Set chart background and text colors based on the current theme
        const chartBackgroundColor = currentTheme === 'dark' ? '#444' : '#fff';
        const chartTextColor = currentTheme === 'dark' ? '#fff' : '#000';
        const chartTooltipBackgroundColor = currentTheme === 'dark' ? '#555' : '#fff';
        const chartTooltipTextColor = currentTheme === 'dark' ? '#fff' : '#000';
    
        const ctx2 = document.getElementById('paymentAnalysisChart').getContext('2d');
        
        const paymentAnalysisChart = new Chart(ctx2, {
            type: 'pie',
            data: {
                labels: ['Payments Done', 'Payments Pending'], 
                datasets: [{
                    data: [paymentAnalysis.done, paymentAnalysis.pending],
                    backgroundColor: ['#6574ff', '#f3590b'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 14,
                                weight: '600',
                                color: chartTextColor, // Set text color based on theme
                            },
                            padding: 20,
                        },
                    },
                    tooltip: {
                        backgroundColor: chartTooltipBackgroundColor, // Set tooltip background color
                        titleColor: chartTextColor, // Set tooltip title color
                        bodyColor: chartTooltipTextColor, // Set tooltip body color
                        callbacks: {
                            label: function(tooltipItem) {
                                let label = tooltipItem.label;
                                let value = tooltipItem.raw;
                                return `${label}: ₱${value.toLocaleString()}`;
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        backgroundColor: chartTooltipBackgroundColor, // Tooltip background
                        titleColor: chartTextColor, // Tooltip title color
                        bodyColor: chartTooltipTextColor, // Tooltip body color
                    }
                }
            }
        });
    </script>
    
   
</body>
</html>
{% endblock %}
