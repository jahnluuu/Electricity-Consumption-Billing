<!-- templates/ECBApp/history.html -->

{% extends 'ECBApp/base.html' %}
{% load static %}

{% block breadcrumb %}
    <a href="{% url 'dashboard' %}" class="breadcrumb-item">Home</a> / 
    <a href="{% url 'history' %}" class="breadcrumb-item">History</a>
{% endblock %}

{% block header_title %}
    Payment and Usage History
{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{% static 'css/history.css' %}?v=1.0">
</head>
<body>
    <div class="container">
        <h2 class="page-title">Payment and Usage History </h2>
        
        <div class ="chart-item2">
            <div class="chart-item">
                <div class="chart-header">
                    <h3>Monthly</h3>
                    <button id="toggleMonthlyButton" onclick="toggleMonthlyChart()">Show Usage</button>
                </div>
                <canvas id="paymentUsageHistogram"></canvas>
                <div class="pagination"> 
                    <span class="step-links"> 
                        {% if page_obj.has_previous %} 
                        <a href="?page={{ page_obj.previous_page_number }}">previous</a> 
                        {% endif %} 
                        
                        <span class="current"> 
                            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}. 
                        </span> 
                        
                        {% if page_obj.has_next %} 
                        <a href="?page={{ page_obj.next_page_number }}">next</a> 
                        {% endif %} 
                    </span> 
                </div>
            </div>
    
            <div class="chart-item">
                <div class="chart-header">
                    <h3>Yearly</h3>
                    <button id="toggleYearlyButton" onclick="toggleYearlyChart()">Show Usage</button>
                </div>
                <canvas id="paymentUsageLineGraph"></canvas>
            </div>
        </div>
    </div>


    <script>
        // Load data from backend
        const paymentMonths = JSON.parse('{{ payment_months|escapejs }}');
        const paymentTotals = JSON.parse('{{ payment_totals|escapejs }}');
        const usageMonths = JSON.parse('{{ usage_months|escapejs }}');
        const usageTotals = JSON.parse('{{ usage_totals|escapejs }}');
        const years = JSON.parse('{{ years|escapejs }}');
        const yearlyPaymentData = JSON.parse('{{ yearly_payment_data|escapejs }}');
        const yearlyUsageData = JSON.parse('{{ yearly_usage_data|escapejs }}');

        // Monthly Payments and Usage Chart
        const ctx1 = document.getElementById('paymentUsageHistogram').getContext('2d');
        const paymentUsageHistogram = new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: paymentMonths, // Use aligned months
                datasets: [{
                    label: 'Monthly Payments (₱)',
                    data: paymentTotals,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Yearly Payments and Usage Chart
        const ctx2 = document.getElementById('paymentUsageLineGraph').getContext('2d');
        const paymentUsageLineGraph = new Chart(ctx2, {
            type: 'line',
            data: {
                labels: years,
                datasets: [{
                    label: 'Yearly Payments (₱)',
                    data: yearlyPaymentData,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Toggle Monthly Chart
        function toggleMonthlyChart() {
            const currentLabel = paymentUsageHistogram.data.datasets[0].label;
            if (currentLabel === 'Monthly Payments (₱)') {
                paymentUsageHistogram.data.datasets[0].label = 'Monthly Usage (kWh)';
                paymentUsageHistogram.data.datasets[0].data = usageTotals;
                document.getElementById('toggleMonthlyButton').innerText = 'Show Payments';
            } else {
                paymentUsageHistogram.data.datasets[0].label = 'Monthly Payments (₱)';
                paymentUsageHistogram.data.datasets[0].data = paymentTotals;
                document.getElementById('toggleMonthlyButton').innerText = 'Show Usage';
            }
            paymentUsageHistogram.update();
        }

        // Toggle Yearly Chart
        function toggleYearlyChart() {
            const currentLabel = paymentUsageLineGraph.data.datasets[0].label;
            if (currentLabel === 'Yearly Payments (₱)') {
                paymentUsageLineGraph.data.datasets[0].label = 'Yearly Usage (kWh)';
                paymentUsageLineGraph.data.datasets[0].data = yearlyUsageData;
                document.getElementById('toggleYearlyButton').innerText = 'Show Payments';
            } else {
                paymentUsageLineGraph.data.datasets[0].label = 'Yearly Payments (₱)';
                paymentUsageLineGraph.data.datasets[0].data = yearlyPaymentData;
                document.getElementById('toggleYearlyButton').innerText = 'Show Usage';
            }
            paymentUsageLineGraph.update();
        }
    </script>
{% endblock %}